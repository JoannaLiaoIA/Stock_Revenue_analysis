---
title: "股票融資損益與追繳價格計算"
author: "Joanna Liao"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
  pdf_document: 
    toc: true
    toc_depth: 2
    latex_engine: xelatex
---

```{R setup, include = FALSE}
knitr::opts_chunk$set(
  results = 'hold',
  warning = FALSE,
  message = FALSE,
  echo = TRUE
)
```


* **[latest version](https://joannaliaoia.github.io/Stock_Revenue_analysis/#安裝需要的套件)**


## 安裝需要的套件
```{R}
required_packages <- c("tidyverse", "knitr")

installed_packages <- rownames(installed.packages())

for (pkg in required_packages) {
  if (!pkg %in% installed_packages) {
    install.packages(pkg, dependencies = TRUE)
  }
  library(pkg, character.only = TRUE)
}

rm(required_packages, installed_packages, pkg)
```

## 參數設定
```{R, echo = TRUE}
loan_ratio <- 0.6
loan_interest_rate <- 0.0248
loan_days <- 180

current_price <- 1680         # 目前收盤價格
target_price <- 2200          # 目標賣出價格
stock_amount_extra <- 4       # 想要買的股票數量
stock_amount_guarantee <- seq(from = 3, to = 6)   # 抵押的股票數量

dividend_per_share <- 5

fee_rate <- 0.003
tax_rate <- 0.001425

my_capital <- 1e7           # 擔保品的總價值
required_rate <- 1.660      # 要求維持率
margin_rate <- 1.3
```

## 函數定義
* `fmt`: 管理數字輸出的格式
* `calc_breakeven_price`: 計算損益兩平價格 -> 多少錢賣出不會賠錢
    * 假設沒有股利
    * 利息以單利計算，已考慮天數
```{R, Function Definitions, echo = TRUE}
options(scipen = 999)  # 關掉科學記號

fmt <- function(x) {
  formatC(x, format = "f", big.mark = ",", digits = 2)
}

calc_breakeven_price <- function(buy_price) {
  breakeven_price <-
    buy_price * (1 + fee_rate + (loan_interest_rate * loan_days/365)) / (1 + fee_rate)
  return(breakeven_price)
}
```

## 計算損益金額和簡單報酬率
* `Buy_price`: 買進價格，以 1/9（五）的收盤價 1680 抓區間，10 元一個區間
    * 目前價格的 90% 到 110%
* `Sell_price`: 賣出價格，以目前價格到目標價格，每 50 元一個區間
```{R}
buy_price <- sort(seq(from = current_price * 0.9, to = current_price * 1.1, by = 10), decreasing = FALSE)
sell_price <- sort(seq(from = current_price, to = target_price, by = 50), decreasing = FALSE)
loan_amount <- my_capital * loan_ratio

df_result <- expand.grid(
  Buy = buy_price,
  Sell = sell_price
  ) %>%
  
  mutate(
    Cost = Buy * stock_amount_extra * 1000,
  
    Capital_gain = Sell * stock_amount_extra * 1000,
    Div_gain = dividend_per_share * stock_amount_extra * 1000,
  
    Fees =
      Cost * fee_rate +
      Capital_gain * fee_rate +
      Capital_gain * tax_rate,
  
    Interest = loan_amount * loan_interest_rate * (loan_days / 365),
  
    NI = Capital_gain + Div_gain - Cost - Fees - Interest,
  
    Return = NI / Cost
  ) %>%

  
  relocate(Buy, Sell, Cost, Interest, Capital_gain, Div_gain, Fees, NI, Return) %>%
  
  filter(Return >= 0)   # 只顯示有賺錢的組合

# 輸出用
unique_buys <- sort(unique(df_result$Buy))

for (b in unique_buys) {

  df_show <- df_result %>%
    
    filter(Buy == b) %>%
    
    mutate(
      Buy = fmt(Buy),
      Sell = fmt(Sell),
      Cost = fmt(Cost),
      Interest = fmt(Interest),
      `Capital Gain` = fmt(Capital_gain),
      `Div Gain` = fmt(Div_gain),
      Fees = fmt(Fees),
      NI = fmt(NI),
      `Return(%)` = round(Return, 4)
    ) %>%
    
    select(-Buy, -Return, -Capital_gain, -Div_gain) %>%
    
    relocate(Sell, Cost, Interest, `Capital Gain`, `Div Gain`, Fees, NI, `Return(%)`)
  
    break_even_price <- fmt(calc_breakeven_price(b))
  
    print(knitr::kable(
      df_show,
      align = "r",
      caption = paste("\n買入價格:", b, "\nBreak Even Price: ", break_even_price)
  ))
}

rm(df_show, df_result, b, unique_buys)
```

## 計算不同借款金額的追繳價格
```{R}
my_capital <- seq(from = 5.5*10^6, to = 1.5*10^7, by = 5*10^5)

# 輸出價格
cat("\n--------------------------------------------------\n")
cat("假設條件：\n")
cat("借款成數:", loan_ratio * 100, "%\n")
cat("維持率:", margin_rate * 100, "%\n")
cat("追繳維持率:", required_rate * 100, "%\n")
cat("買進價格區間:", fmt(min(buy_price)), "元 ~", fmt(max(buy_price)), "元\n")
cat("--------------------------------------------------\n\n")

for (capital in my_capital) {
  loan_amount <- capital * loan_ratio
  
  cat("總共資金：", fmt(capital), "\n")
  cat("可用金額：", fmt(loan_amount), "\n")

  # 計算追繳價格
  for(stock_amount in stock_amount_guarantee) {
    cat("\n抵押張數:", stock_amount, "\n")
    margin_call_price <- (margin_rate * loan_amount) / (stock_amount * 1000)
    margin_at_call <- (required_rate * loan_amount - margin_call_price * stock_amount * 1000) / margin_rate
    
    cat("追繳價格:", round(margin_call_price, 2), "\n")
    cat("需要補繳:", fmt(margin_at_call), "\n")
  }
  
  min_stock_amount <- floor(loan_amount / (max(buy_price) * 1000))
  max_stock_amount <- floor(loan_amount / (min(buy_price) * 1000))
  stock_amount_range <- seq(from = min_stock_amount, to = max_stock_amount)
  price_at_amt <- loan_amount / (stock_amount_range * 1000)
  
  cat("\n\n")
  for (i in seq_along(stock_amount_range)) {
  
    upper <- price_at_amt[i]
    lower <- if (i < length(price_at_amt)) price_at_amt[i + 1] else min(buy_price)
  
      cat(fmt(lower), "< 價格 ≤", fmt(upper),
          "可以買", stock_amount_range[i], "張\n")
    
  }

  
  cat("\n\n")
  
  # 可以買到預期數量的最高價
  stock_amount_expect <- seq(from = 4, to = 6)
  
  for (expect in stock_amount_expect) {
    max_buy_price <- (capital - loan_amount) / (expect * 1000)
    cat("想買", expect, "張，可以買到的最高價格：", fmt(max_buy_price), "元\n")
  }
  
cat("\n--------------------------------------------------\n\n")
}
```
